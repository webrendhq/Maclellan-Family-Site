name: Jekyll Build with Secrets

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Create _config.yml with secrets
        run: |
          cat > _config.yml <<EOL
          # Site settings
          title: Your Site Title
          description: Your site description
          
          # Build settings
          markdown: kramdown
          
          # Environment variables
          firebase_config:
            apiKey: ${{ secrets.FIREBASE_API_KEY }}
            authDomain: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
            projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
            storageBucket: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
            messagingSenderId: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
            appId: ${{ secrets.FIREBASE_APP_ID }}

          aws_config:
            accessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
            secretAccessKey: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            region: ${{ secrets.AWS_S3_REGION || 'us-east-2' }}
            bucket: ${{ secrets.AWS_S3_BUCKET || 'maclellanfamily.com' }}
            baseFolder: ${{ secrets.AWS_BASE_FOLDER || '0 US' }}
            urlExpiration: ${{ secrets.URL_EXPIRATION || '3600' }}
          EOL

      - name: Create environment.js
        run: |
          mkdir -p assets/js
          cat > assets/js/environment.js <<EOL
          const firebaseConfig = {
              apiKey: "${{ secrets.FIREBASE_API_KEY }}",
              authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
              projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
              storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
              messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
              appId: "${{ secrets.FIREBASE_APP_ID }}"
          };

          const awsConfig = {
              accessKeyId: "${{ secrets.AWS_ACCESS_KEY_ID }}",
              secretAccessKey: "${{ secrets.AWS_SECRET_ACCESS_KEY }}",
              region: "${{ secrets.AWS_S3_REGION || 'us-east-2' }}",
              bucket: "${{ secrets.AWS_S3_BUCKET || 'maclellanfamily.com' }}",
              baseFolder: "${{ secrets.AWS_BASE_FOLDER || '0 US' }}",
              urlExpiration: ${{ secrets.URL_EXPIRATION || 3600 }}
          };
          EOL

      - name: Install dependencies
        run: |
          bundle config path vendor/bundle
          bundle install

      - name: Build with Jekyll
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  # Deploy job
  deploy:
    # Add a dependency to the build job
    needs: build

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4