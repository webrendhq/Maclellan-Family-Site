(()=>{var e={};e.id=748,e.ids=[748],e.modules={1043:e=>{"use strict";e.exports=require("@aws-sdk/client-s3")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},5511:e=>{"use strict";e.exports=require("crypto")},9021:e=>{"use strict";e.exports=require("fs")},1630:e=>{"use strict";e.exports=require("http")},3496:e=>{"use strict";e.exports=require("http2")},5591:e=>{"use strict";e.exports=require("https")},1820:e=>{"use strict";e.exports=require("os")},3873:e=>{"use strict";e.exports=require("path")},7910:e=>{"use strict";e.exports=require("stream")},9801:e=>{"use strict";e.exports=import("firebase-admin/app")},4276:e=>{"use strict";e.exports=import("firebase-admin/auth")},7879:e=>{"use strict";e.exports=import("firebase-admin/firestore")},2363:(e,r,t)=>{"use strict";t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{patchFetch:()=>l,routeModule:()=>p,serverHooks:()=>m,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>d});var o=t(2706),n=t(8203),i=t(5994),a=t(2894),c=e([a]);a=(c.then?(await c)():c)[0];let p=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/s3/route",pathname:"/api/s3",filename:"route",bundlePath:"app/api/s3/route"},resolvedPagePath:"C:\\Users\\kevin\\OneDrive\\Documents\\GitHub\\MaclellanFamily.com2\\maclellanfamily\\app\\api\\s3\\route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:u,workUnitAsyncStorage:d,serverHooks:m}=p;function l(){return(0,i.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:d})}s()}catch(e){s(e)}})},6487:()=>{},8335:()=>{},2894:(e,r,t)=>{"use strict";t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{GET:()=>u});var o=t(9187),n=t(1043),i=t(9483),a=t(4276),c=t(7879),l=t(9801),p=e([a,c,l]);if([a,c,l]=p.then?(await p)():p,!(0,l.getApps)().length)try{(0,l.initializeApp)({credential:(0,l.cert)({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_ADMIN_CLIENT_EMAIL,privateKey:process.env.FIREBASE_ADMIN_PRIVATE_KEY})}),console.log("Firebase Admin initialized successfully")}catch(e){throw console.error("Firebase Admin initialization error:",e),e}let d=new n.S3Client({region:process.env.AWS_S3_REGION||"us-east-2",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID||"",secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY||""}});async function u(e){console.log("API route handler started");try{console.log("Environment check:",{hasProjectId:!!process.env.FIREBASE_PROJECT_ID,hasClientEmail:!!process.env.FIREBASE_ADMIN_CLIENT_EMAIL,hasPrivateKey:!!process.env.FIREBASE_ADMIN_PRIVATE_KEY,hasAwsRegion:!!process.env.AWS_S3_REGION,hasAwsAccessKey:!!process.env.AWS_ACCESS_KEY_ID,hasAwsSecretKey:!!process.env.AWS_SECRET_ACCESS_KEY,hasAwsBucket:!!process.env.AWS_S3_BUCKET});let r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return console.log("No valid authorization header found"),o.NextResponse.json({error:"Unauthorized"},{status:401});let t=r.split("Bearer ")[1];console.log("Got token, attempting verification");let s=(await (0,a.getAuth)().verifyIdToken(t)).uid;console.log("Token verified for user:",s);let l=(0,c.getFirestore)(),p=await l.collection("users").doc(s).get(),u=p.data()?.folderPath||"";console.log("Retrieved folder path:",u);let m=`${process.env.AWS_BASE_FOLDER}${u}/`;console.log("S3 prefix:",m);let g=new n.ListObjectsV2Command({Bucket:process.env.AWS_S3_BUCKET,Prefix:m,Delimiter:"/"}),E=await d.send(g);console.log("S3 response received:",{prefixCount:E.CommonPrefixes?.length||0,contentCount:E.Contents?.length||0});let h=(E.CommonPrefixes||[]).map(async e=>{if(!e.Prefix)return null;let r=e.Prefix.split("/").slice(-2)[0];console.log(`
Processing folder: ${r}`);let t=await d.send(new n.ListObjectsV2Command({Bucket:process.env.AWS_S3_BUCKET,Prefix:e.Prefix,Delimiter:""})),s=t.Contents?.filter(e=>e.Key?.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/i)).map(e=>e.Key)||[],o=null;if(s.length>0){let e=s[Math.floor(Math.random()*s.length)];if(e){console.log(`Selected image key for ${r}:`,e);let t=new n.GetObjectCommand({Bucket:process.env.AWS_S3_BUCKET,Key:e});o=await (0,i.A)(d,t,{expiresIn:3600}),console.log(`Generated presigned URL for ${r}:`,o)}}return{name:r,backgroundUrl:o,totalImages:s.length}}),A=(await Promise.all(h)).filter(e=>null!==e).sort((e,r)=>parseInt(e.name)-parseInt(r.name));return console.log("\nFinal folders data:",A.map(e=>({name:e?.name,hasUrl:!!e?.backgroundUrl,urlPreview:e?.backgroundUrl?`${e.backgroundUrl.substring(0,50)}...`:"none"}))),o.NextResponse.json(A)}catch(e){return console.error("Detailed error:",e),e instanceof Error&&console.error({name:e.name,message:e.message,stack:e.stack,cause:e.cause}),o.NextResponse.json({error:"Internal Server Error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}s()}catch(e){s(e)}})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[989,452,483],()=>t(2363));module.exports=s})();